'use strict';var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!(i&&_arr.length===i));_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i['return']&&_i['return']()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return sliceIterator(arr,i);throw new TypeError('Invalid attempt to destructure non-iterable instance')}}(),chanTop={vstep:50,init:function init(a,b){this.$el=a.addClass('chantop'),this.$el.empty(),this.chans=b,this.load()},makeCSS:function makeCSS(a){var b='',c=this.vstep;_.range(a).forEach(function(d){var f='';has3d?['','-webkit-'].forEach(function(g){f+=g+'transform: translate3d(0, '+c*d+'px, 0);\n'}):f+='top: '+(c*d+10)+'px;',b+='#co-'+d+' {\n'+f+'}\n'}),b+='.chantop { height: '+a*c+'px }',injector.inject('chantop-positions',b)},load:function load(){var _this=this;this.makeCSS(this.chans.length),this.chans.forEach(function(a){a.$el=$(_this.buildChan(a)),a.$el.find('.adder-remover').click(function(){installer.toggle(a.id)}),_this.$el.append(a.$el)}),API.getRates(),this.upd=setInterval(function(){new Date().getTime()-_this.lastUpdated>_this.interval/2&&!$('#chantop').is(':hover')&&'hidden'!==$('#chantop').css('visibility')&&API.getRates()},this.interval)},stahp:function stahp(){clearInterval(this.upd)},updateRatings:function updateRatings(a){this.lastUpdated=new Date().getTime();var b=_.map(this.chans,'id'),c=_.map(a,'id');return c.length!==b.length||_.difference(b,c).length?void document.location.reload():void(this.chans.forEach(function(d){d.rating=+_.find(a,{id:d.id}).rating,d.$el.find('.chan-rating').text(d.rating)}),this.arrange())},interval:5e3,buildChan:function buildChan(a){var b=installer.isInstalled(a.id),c=b?'\xD7':'+',d=b?'\u0423\u0434\u0430\u043B\u0438\u0442\u044C':'\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C',f=_.escape(a.name),g=a.wiki&&a.wiki.match(/https?:\/\//)?a.wiki:conf.wiki+(a.wiki||f);return'<div class="ct-chan"><img src="/chans/balls/'+a.section+'/'+a.id+'.png?uid='+a._id+(a.ballv?'&v='+a.ballv:'')+'" alt="'+f+'" class="chan-avatar"><div class="catc-addremove adder-remover" title="'+d+'">'+c+'</div><a href="'+_.escape(a.url)+'" target="_blank" class="chan-name"><span>'+f+'</span></a><div class="chan-rating">'+a.rating+'</div><div class="chan-rating-delta"></div><a target="_blank" href="'+g+'" class="catc-info" title="\u0418\u043D\u0444\u043E\u0440\u043C\u0430\u0446\u0438\u044F">i</a></div>'},arrange:function arrange(){var _this2=this;_.sortByOrder(chanTop.chans,['rating','name'],['desc','asc']).forEach(function(a,b){if(a.$el.attr('id','co-'+b),_this2.arranged){var c=' hovering';if(b<a.order?c+=' going-up':b>a.order?c+=' going-down':c='',a.rating!==a.oldRating){var f,d=a.rating-a.oldRating;0<d?(f='plus',d='+'+d):f='minus',a.$el.find('.chan-rating-delta').text(''+d).removeClass('plus minus').addClass(f)}a.$el.addClass(c+(d?' delta-show':'')),setTimeout(function(){return a.$el.removeClass('hovering going-down going-up delta-show')},1e3)}a.order=b,a.oldRating=a.rating}),this.arranged=!0},arranged:!1,mockRandOrder:function mockRandOrder(a){a=a||0.3,this.chans.forEach(function(b){Math.random()<a&&(b.rating=Math.round(1e3*Math.random()),b.$el.find('.chan-rating').text(''+b.rating))}),this.arrange()}},API={getRates:function getRates(){this.request('rates')},getChallenge:function getChallenge(){this.request('challenge')},captcha:function captcha(a){this.request('captcha','POST',{captcha:a})},vote:function vote(a){'left'!==a&&'right'!==a&&this.handleError('You can only vote Left or Right'),this.request('vote','POST',{v:a})},request:function request(a,b,c){var _this3=this;$.ajax({url:'api.php?act='+a,type:b||'GET',data:c||null}).done(function(d){return d.error?_this3.handleError(d.error):void _this3.handleData(d.data)}).fail(function(d){return _this3.handleError('XHR error: ',d)})},handleData:function handleData(a){a.hasOwnProperty('vote_success')&&$('body').removeClass('enter-captcha'),a.hasOwnProperty('rates')&&chanTop.updateRatings(a.rates),a.hasOwnProperty('challengers')&&Masher.setNewChallenge(a.challengers),a.hasOwnProperty('debug')&&console.log(a.debug)},handleError:function handleError(a){return this.specialErrors.hasOwnProperty(a)?this.specialErrors[a]():console.error(a),!1},specialErrors:{enter_captcha:function enter_captcha(){$('body').addClass('enter-captcha'),updateCaptcha()},wrong_captcha:function wrong_captcha(){$('#captcha-panel').addClass('wrong'),setTimeout(function(){return $('#captcha-panel').removeClass('wrong')},1e3),updateCaptcha()},force_reload:function force_reload(){return document.location.reload()}}};function updateCaptcha(){$('#cpanel-wrap img').attr('src','/captcha.php?color=200,200,200'),$('input[name=captcha]').val('').focus()}var Masher={init:function init(a,b){var _this4=this;this.$el=a;var c='';b.forEach(function(d){var f=$(_this4.buildChan(d));f.find('a, .chan-options').click(function(g){g.stopPropagation()}),f.find('.adder-remover').click(function(){installer.toggle(d.id)}),_this4.pool[d.id]=f,c+='\n#ch_'+d.id+' {\n '+_this4.gradient(d.catbg)+' \n}'}),injector.inject('catalog-gradients',c),$('.challenger').click(function(){$('.catalog-chan').addClass('post'),API.vote($(this).attr('id').split('c-')[1])}),API.getChallenge()},pool:{},buildChan:function buildChan(a){var b=installer.isInstalled(a.id),c=b?'\xD7':'+',d=b?'\u0423\u0434\u0430\u043B\u0438\u0442\u044C':'\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C',f=_.escape(a.name),g=a.wiki&&a.wiki.match(/https?:\/\//)?a.wiki:conf.wiki+(a.wiki||f);return'<div class="catalog-chan"><div class="cc-ball-wrap" id="ch_'+a.id+'"><img src="/chans/balls/'+a.section+'/'+a.id+'.png?uid='+a._id+(a.ballv?'&v='+a.ballv:'')+'" alt="'+f+'" class="cc-ball"><a href="'+_.escape(a.url)+'" target="_blank" class="channame-overlay">'+f+'</a><div class="chan-options co-add adder-remover" title="'+d+'">'+c+'</div><a href="'+g+'" target="_blank" class="chan-options co-info" title="\u0418\u043D\u0444\u043E\u0440\u043C\u0430\u0446\u0438\u044F">i</a></div></div>'},setNewChallenge:function setNewChallenge(a){var _this5=this,_a$map=a.map(function(d){return d=_this5.pool[d.id].addClass('pre').removeClass('post')}),_a$map2=_slicedToArray(_a$map,2),b=_a$map2[0],c=_a$map2[1];$('#c-left').append(b),$('#c-right').append(c),setTimeout(function(){$('.challenger .catalog-chan').removeClass('pre')},500)},gradient:function gradient(a){var b='linear-gradient(to bottom, #'+a[0]+' 0%, #'+a[1]+' 100%)',c=/(((?:radial|linear)-gradient)\((?:(ellipse) at center|(-?[0-9]+)deg|to (right|bottom)), ?(.+)\));?/i.exec(b);if(null===c)return'background:'+b;c=_.rest(_.without(c,void 0));var g,d=c[0]+'; ',f=c[1];g=isNaN(c[2])?'bottom'==c[2]?'top, ':'right'==c[2]?'left, ':'center, ellipse cover, ':90-parseFloat(c[2])+'deg, ';var h=c[3];return _.each(['-o-','-webkit-','-moz-'],function(j){d+='background:'+j+f+'('+g+h+'); '}),'background:'+d}};function main(){$.ajaxSetup({dataType:'json'}),$.getJSON('/chans/chans.json?v='+new Date().getTime()).done(function(a){a.chans&&a.version?initAll(a.chans,a.version):console.error('bad-json')}).fail(function(a){return console.error(a)}),has3d=has3d()}function initAll(a,b){a.forEach(function(c){c.section=c.default?'default':'custom'}),installer.init(a,b),chanTop.init($('#chantop'),a),Masher.init($('#battleground'),a),$('header').click(function(){if(640>=$(window).width()){var c=$('body').hasClass('xpnd');$('body').toggleClass('xpnd'),c||$('#battleground-wrap').scrollTop(0)}}),$('#cpanel-wrap img').click(updateCaptcha),$('#captcha-panel').submit(function(c){c.preventDefault(),API.captcha($('input[name=captcha]').val())}),$(window).keydown(function(c){$('body').hasClass('enter-captcha')||((37==c.keyCode||65==c.keyCode)&&API.vote('left'),(39==c.keyCode||68==c.keyCode)&&API.vote('right'))})}var installer={installed:[],init:function init(a,b){var _this6=this;this.list=a,this.versions=LSfetchJSON('catalogVersions')||{},this.versions.server=b;var c=LSfetchJSON('myChans_new');c&&c.length?c.forEach(function(d){var f=_.find(a,{id:d.id});_this6.installed.push(f||d)}):this.installed=_.filter(a,{included:!0}),this.sync(!0)},sync:function sync(a){localStorage.myChans_new=JSON.stringify(this.installed),a&&(localStorage.catalogVersions=JSON.stringify(this.versions))},isInstalled:function isInstalled(a){return!!_.find(this.installed,{id:a})},indicate:function indicate(a,b,c){[Masher.pool[a],_.find(chanTop.chans,{id:a}).$el].forEach(function(d){d.find('.adder-remover').text(b).attr('title',c)})},install:function install(a){var b=_.find(this.list,{id:a});b&&(this.installed.push(b),this.sync(),this.indicate(a,'\xD7','\u0423\u0434\u0430\u043B\u0438\u0442\u044C'))},uninstall:function uninstall(a){var b=_.remove(this.installed,{id:a});b&&(this.sync(),this.indicate(a,'+','\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C'))},toggle:function toggle(a){this.isInstalled(a)?this.uninstall(a):this.install(a)}},conf={wiki:'http://wiki.1chan.ca/'},injector={inject:function inject(a,b){var c='injector:'+a,d=document.getElementById(c);if(d)return void(d.innerHTML=b);var f=document.head||document.getElementsByTagName('head')[0],g=document.createElement('style');g.type='text/css',g.id=c,g.styleSheet?g.styleSheet.cssText=b:g.appendChild(document.createTextNode(b)),f.appendChild(g)},remove:function remove(a){var b='injector:'+a,c=document.getElementById(b);if(c){var d=document.head||document.getElementsByTagName('head')[0];d&&d.removeChild(document.getElementById(b))}}};function has3d(){if(!window.getComputedStyle)return!1;var b,a=document.createElement('p'),c={webkitTransform:'-webkit-transform',OTransform:'-o-transform',msTransform:'-ms-transform',MozTransform:'-moz-transform',transform:'transform'};for(var d in document.body.insertBefore(a,null),c)void 0!==a.style[d]&&(a.style[d]='translate3d(1px,1px,1px)',b=window.getComputedStyle(a).getPropertyValue(c[d]));return document.body.removeChild(a),void 0!==b&&0<b.length&&'none'!==b}function LSfetchJSON(a){var b=null,c=localStorage[a];if('undefined'!=typeof c)try{b=JSON.parse(c)}catch(d){console.error(d),localStorage.removeItem(a)}return b}
//# sourceMappingURL=chantop.js.map