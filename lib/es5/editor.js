'use strict';var _typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&'function'==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?'symbol':typeof obj},_templateObject=_taggedTemplateLiteral(['#',''],['#','']),_templateObject2=_taggedTemplateLiteral(['#position-tweak-',''],['#position-tweak-','']),_templateObject3=_taggedTemplateLiteral(['#bgc-',''],['#bgc-','']),_templateObject4=_taggedTemplateLiteral(['<li class="cat-brd ','">\n\t\t<input type="text" class="board-dir" value="','">\n\t\t<input type="text" class="board-desc" value="','">\n\t\t<div class="dragger" title="\u0421\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0434\u043E\u0441\u043A\u0438"><svg class="b-option icon"><use xlink:href="#i-drag"></use></svg></div>\n\t\t<button class="b-option delb delboard" title="\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0434\u043E\u0441\u043A\u0443"><svg class="icon"><use xlink:href="#i-x"></use></svg></button>\n\t</li>'],['<li class="cat-brd ','">\n\t\t<input type="text" class="board-dir" value="','">\n\t\t<input type="text" class="board-desc" value="','">\n\t\t<div class="dragger" title="\u0421\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0434\u043E\u0441\u043A\u0438"><svg class="b-option icon"><use xlink:href="#i-drag"></use></svg></div>\n\t\t<button class="b-option delb delboard" title="\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0434\u043E\u0441\u043A\u0443"><svg class="icon"><use xlink:href="#i-x"></use></svg></button>\n\t</li>']),_templateObject5=_taggedTemplateLiteral(['#tree .invalid.inv_',''],['#tree .invalid.inv_','']),_templateObject6=_taggedTemplateLiteral(['#','-tipper'],['#','-tipper']),_templateObject7=_taggedTemplateLiteral(['','','',''],['','','','']),_templateObject8=_taggedTemplateLiteral(['#','Color'],['#','Color']),_templateObject9=_taggedTemplateLiteral(['<li class="stream','">\n\t\t<input type="text" class="stream-name" placeholder="\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0441\u0442\u0440\u0438\u043C\u0430" title="\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0441\u0442\u0440\u0438\u043C\u0430" maxlength="20" value="','">\n\t\t<input type="text" class="stream-range" placeholder="\u0414\u0438\u0430\u043F\u0430\u0437\u043E\u043D" title="\u0414\u0438\u0430\u043F\u0430\u0437\u043E\u043D" maxlength="20" value="','">\n\t\t<div class="stream-options">\n\t\t\t<button class="b-option templatize" title="\u0420\u0430\u0437\u043C\u043D\u043E\u0436\u0430\u0442\u044C \u043F\u043E \u0448\u0430\u0431\u043B\u043E\u043D\u0443"><svg class="icon">\n\t\t\t\t<use class="for-templated-hide" xlink:href="#i-template"></use>\n\t\t\t\t<use class="for-templated-show" xlink:href="#i-untemplate"></use>\n\t\t\t</svg></button>\n\t\t\t<div class="dragger" title="\u0421\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0438\u043C\u044B"><svg class="b-option icon"><use xlink:href="#i-drag"></use></svg></div>\n\t\t\t<button class="b-option delstream" title="\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0441\u0442\u0440\u0438\u043C"><svg class="icon"><use xlink:href="#i-x"></use></svg></button><br>\n\t\t</div>\n\t\t<br>\n\t\t<input type="text" class="stream-path" placeholder="/path \u0441\u0442\u0440\u0438\u043C\u0430" title="/path \u0441\u0442\u0440\u0438\u043C\u0430" maxlength="50" value="','">\n\t\t<input type="text" class="stream-mime" placeholder="MIME \u0441\u0442\u0440\u0438\u043C\u0430" title="MIME \u0441\u0442\u0440\u0438\u043C\u0430" maxlength="20" value="','">\n\t</li>'],['<li class="stream','">\n\t\t<input type="text" class="stream-name" placeholder="\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0441\u0442\u0440\u0438\u043C\u0430" title="\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0441\u0442\u0440\u0438\u043C\u0430" maxlength="20" value="','">\n\t\t<input type="text" class="stream-range" placeholder="\u0414\u0438\u0430\u043F\u0430\u0437\u043E\u043D" title="\u0414\u0438\u0430\u043F\u0430\u0437\u043E\u043D" maxlength="20" value="','">\n\t\t<div class="stream-options">\n\t\t\t<button class="b-option templatize" title="\u0420\u0430\u0437\u043C\u043D\u043E\u0436\u0430\u0442\u044C \u043F\u043E \u0448\u0430\u0431\u043B\u043E\u043D\u0443"><svg class="icon">\n\t\t\t\t<use class="for-templated-hide" xlink:href="#i-template"></use>\n\t\t\t\t<use class="for-templated-show" xlink:href="#i-untemplate"></use>\n\t\t\t</svg></button>\n\t\t\t<div class="dragger" title="\u0421\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0438\u043C\u044B"><svg class="b-option icon"><use xlink:href="#i-drag"></use></svg></div>\n\t\t\t<button class="b-option delstream" title="\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0441\u0442\u0440\u0438\u043C"><svg class="icon"><use xlink:href="#i-x"></use></svg></button><br>\n\t\t</div>\n\t\t<br>\n\t\t<input type="text" class="stream-path" placeholder="/path \u0441\u0442\u0440\u0438\u043C\u0430" title="/path \u0441\u0442\u0440\u0438\u043C\u0430" maxlength="50" value="','">\n\t\t<input type="text" class="stream-mime" placeholder="MIME \u0441\u0442\u0440\u0438\u043C\u0430" title="MIME \u0441\u0442\u0440\u0438\u043C\u0430" maxlength="20" value="','">\n\t</li>']),_templateObject10=_taggedTemplateLiteral(['#streams .invalid.inv_',''],['#streams .invalid.inv_','']),_templateObject11=_taggedTemplateLiteral(['.stream-',''],['.stream-','']),_templateObject12=_taggedTemplateLiteral(['<li class="lib-chan sect-','','" id="chan_','" data-search="','">\n\t\t\t<img src="','" class="lib-chanball">\n\t\t\t<div class="chan-title">','</div>'],['<li class="lib-chan sect-','','" id="chan_','" data-search="','">\n\t\t\t<img src="','" class="lib-chanball">\n\t\t\t<div class="chan-title">','</div>']),_templateObject13=_taggedTemplateLiteral(['#chan_',''],['#chan_','']),_templateObject14=_taggedTemplateLiteral(['.tab[data-tab=',']'],['.tab[data-tab=',']']),_templateObject15=_taggedTemplateLiteral(['#chan-',''],['#chan-','']);function _taggedTemplateLiteral(strings,raw){return Object.freeze(Object.defineProperties(strings,{raw:{value:Object.freeze(raw)}}))}var IS_ADMIN=!1,main=function main(){function a(){return libchan.setMode('new','drafts'),drafts.submit(1),!1}LSfetchJSON('IS_ADMIN')&&(IS_ADMIN=!0,$('body').addClass('is-admin')),$('#chan-library').toggleClass('expanded',1==localStorage['chanlib-expanded']),setTimeout(function(){return injector.inject('lib-collapse','.collapsible-content {  transition: width 0.3s; }')},100),$.ajaxSetup({dataType:'json'}),$('.tipper').each(function(){$(this).prepend('\n\t\t\t<svg class="icon t-i-q"><use xlink:href="#i-question"></use></svg>\n\t\t\t<svg class="icon t-i-e"><use xlink:href="#i-warning"></use></svg>\n\t\t\t<svg class="icon t-i-s spinning"><use xlink:href="#i-spinner"></use></svg>\n\t\t\t<svg class="icon t-i-ok"><use xlink:href="#i-check"></use></svg>')}).append('<div class="tooltip-wrap error-msg"><div class="tooltip"></div></div>'),$('.validable').each(function(){var _this2=this,g=$(this).parents('.tip-container').find('.tipper');this.showErrors=mkErrorShower(g),this.errorDescriptors={'too-long':'\u0421\u043B\u0438\u0448\u043A\u043E\u043C \u0434\u043B\u0438\u043D\u043D\u043E\u0435 \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u0435 \u043F\u043E\u043B\u044F','too-short':'\u0421\u043B\u0438\u0448\u043A\u043E\u043C \u043A\u043E\u0440\u043E\u0442\u043A\u043E\u0435 \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u0435 \u043F\u043E\u043B\u044F',invalid:'\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u0444\u043E\u0440\u043C\u0430\u0442 \u0434\u0430\u043D\u043D\u044B\u0445',missing:'\u041F\u043E\u043B\u0435 \u043E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u044C\u043D\u043E \u0434\u043B\u044F \u0432\u0432\u043E\u0434\u0430',occupied:'\u0417\u043D\u0430\u0447\u0435\u043D\u0438\u0435 \u0437\u0430\u043D\u044F\u0442\u043E'},$(this).attr('pattern')&&(this.patternRX=new RegExp($(this).attr('pattern'))),this.validate=function(h,j){return new Promise(function(l,o){var p=$(_this2),q=p.val(),s=[];if(q=q.trim(),p.val(q),q){var x=p.attr('maxlength'),y=p.attr('minlength');y&&q.length<y&&s.push('\u0421\u043B\u0438\u0448\u043A\u043E\u043C \u043A\u043E\u0440\u043E\u0442\u043A\u043E\u0435 \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u0435 \u043F\u043E\u043B\u044F (\u043D\u0443\u0436\u043D\u043E \u043C\u0438\u043D\u0438\u043C\u0443\u043C '+y+' \u0441\u0438\u043C\u0432.)'),_this2.patternRX&&!q.match(_this2.patternRX)&&s.push('invalid');var z=p.data('valconvert');z&&validations.hasOwnProperty(z)&&(q=validations[z](q)),x&&q.length>x&&s.push('\u041F\u0440\u0435\u0432\u044B\u0448\u0435\u043D\u0430 \u043C\u0430\u043A\u0441. \u0434\u043B\u0438\u043D\u0430 \u043F\u043E\u043B\u044F ('+x+' \u0441\u0438\u043C\u0432\u043E\u043B\u043E\u0432)')}else $(_this2).prop('required')&&s.push('missing');var t=function t(){h||_this2.showErrors(s),s.length?j?l(q):o(s):(g.setTipperState('valid'),l(q))},u=p.data('aftervalid');s.length?t():(g.setTipperState('spinner'),u&&validations[u]?validations[u](q,p.data('uniq')).then(function(){return t()},function(x){s.push(x),t()}):t())})}}).on('focus',function(){var g=$(this),h=g.parents('.tip-container'),j=h.find('.tipper')}),$('.validable:not(.no-val-onblur)').on('blur',function(){this.validate().then(_.noop,_.noop)}),$('#color-selector .colorbox').change(gradient.update.bind(gradient)),$('#change-direction').click(function(){var g=$(this).find('use'),h=0>g.attr('transform').indexOf('-90');g.attr('transform','rotate('+(h?'-':'')+'90 8 8)');var j=$('#bgc-from')[0],l=$('#bgc-to')[0],o=[l.id,j.id];j.id=o[0],l.id=o[1],gradient.update()}),$('body').on('click','.add-board',function(){tree.addBoard($(this))}).on('click','.delboard',function(){tree.removeBoard($(this))}).on('click','.delcat',function(){var g=$(this).parents('.tree-cat');g.hasClass('predelete')||g.hasClass('empty')?tree.removeCategory($(this)):g.addClass('predelete')}).on('click','.cat-undelete',function(){$(this).parents('.tree-cat').removeClass('predelete')}).on('click','.f-minus, .f-plus',function(){$(this).parents('.tree-cat').toggleClass('hidden')}).on('click','.add-cat',tree.addCategory.bind(tree)).on('input','.board-dir',function(){$(this).parents('.cat-brd').toggleClass('external',!!$(this).val().match(/^https?:\/\//))}).on('mouseup mouseleave blur touchend touchcancel',function(){b=!1}).on('click','.delstream',function(){radio.removeStream($(this))}).on('click','.templatize',function(){$(this).parents('.stream').toggleClass('templated').find('.stream-range').focus()}).on('blur','#tree input',tree.validateUI.bind(tree)).on('click','.lib-chan',function(){libchan.load(this._libdata)}).on('dragenter dragend dragover drop dragleave',function(g){g.preventDefault(),g.stopPropagation()}).on('dragenter',function(){$(this).addClass('dropping'),clearTimeout(this.offTimeout)}).on('dragend drop dragleave',function(g){var _this3=this;g.currentTarget===g.target&&(this.offTimeout=setTimeout(function(){$(_this3).removeClass('dropping')},100))}).on('click','.export-draft',function(g){g.stopPropagation();var h=$(this).parent('.lib-chan'),j=h[0]._libdata;downloadJSON(j,j.id)}),$('.chanball-wrap').on('dragenter dragend dragover drop dragleave',function(g){g.preventDefault(),g.stopPropagation()}).on('dragenter dragover',function(){$(this).addClass('file-over'),clearTimeout(this.offTimeout)}).on('dragend drop dragleave',function(){var _this4=this;this.offTimeout=setTimeout(function(){$(_this4).removeClass('file-over')},100)}).on('drop',ball.handleFile.bind(ball)),$('#radio-editor').on('blur','input',function(){radio.getData().then(_.noop,_.noop)});var b=!1;$('.chanball-dropzone').click(function(){return $('#chanballFileInput').click()}),$('#chanballFileInput').on('change',ball.handleFile.bind(ball)),$('#view-toggle .switch-body').click(function(){return tree.toggleView()}),$('#view-toggle label').click(function(){tree.toggleView($(this).text())}),$('#reup-chanball').click(function(){$('#chanballFileInput').click()}),$('.password-reveal').on('mousedown',function(){$(this).parent().find('input').attr('type','text')}).on('mouseleave mouseup',function(){$(this).parent().find('input').attr('type','password')}),$('#pswd').on('focus',function(){this.removeAttribute('readonly')}).on('blur',function(){this.setAttribute('readonly',!0)}),$('.cb-position-tweaker button').on('mousedown touchstart',function(){var _this5=this;b=!0;var g=function g(h){if(!h&&!b)return clearInterval(_this5.incrementor);var j=$(_this5).parent().find('input'),l=+$(_this5).data('inc');j.val(+j.val()+l),ball.offset()};g(!0),this.incrementor=setInterval(g,150)}).parent().find('input').on('input paste change',ball.offset),$('#tree-json').on('blur',function(){tree.validateJSON()}),$('#chan-name').on('input paste change',function(){$('.channame-overlay').text($(this).val())}),$('#color-theme input.color').change(styles.update.bind(styles)),$('#less-enter').on('input',styles.update.bind(styles)),$('#less-preamble').html(styles.preamble('html')),$('#less-enter').val(styles.base),$('.binded').each(function(){var g=$(this),h=g.data('bind'),j=$(jq(_templateObject,h));j.length&&j.on('input change paste',function(){g.text($(this).val()||'{'+h+'}')}).trigger('change')}),window.updateBindings=function(){$('.binded').each(function(){$(jq(_templateObject,$(this).data('bind'))).trigger('change')})},$('#advance-less').change(function(){var g=$('#less-enter');$(this).prop('checked')?$('.advanced-less').slideDown(function(){g.prop('disabled',0),g[0].preValue&&g.val(g[0].preValue)}):(g[0].preValue=g.val(),g.val(styles.base).prop('disabled',1)),styles.update()}),$('.captcha').click(refreshCaptcha).addClass('not-loaded'),$('.widget-list input').on('change',function(){$(jq(_templateObject,$(this).attr('name'))).toggle($(this).prop('checked'))}),$('.expander').click(function(){$(this).parents('.expandee').toggleClass('expanded')}),$('#onchan').on('change',function(){$('.chan').toggleClass('onchan',$(this).prop('checked'))}),styles.update(),$('#add-stream').click(radio.addStream.bind(radio)),Sortable.create(document.querySelector('#categories'),{handle:'.cat-dragger',animation:150}),Sortable.create(document.querySelector('#streams'),{handle:'.dragger',animation:150}),$('.sidebar').click(toggleLib);var d='default';$('.tab').click(function(){var g=$(this).data('tab'),h=$('#chan-library'),j=!1;'search'===g?h.hasClass('show-search')?g=d:j=!0:d=g,h.find('.tab').removeClass('selected'),h.find('.tab[data-tab='+g+']').addClass('selected'),h.removeClass('show-custom show-default show-drafts show-search').addClass('show-'+g),j&&$('#searchbox').focus()}),$('#searchbox').on('input paste',function(){var g=$(this).val().trim().replace(/\"/g,'\\"').toLowerCase();g.length?injector.inject('lib-search','.show-search .lib-chan[data-search *= "'+g+'"] {height: 40px}'):injector.remove('lib-search')}),upForm.init(),$.getJSON('/chans/chans.json?v='+new Date().getTime()).done(function(g){return library.build(g.chans)}),$('#new-chan').click(function(){return libchan.clear()}),$('#clone-this').click(function(){return libchan.clone()}),$('#publish').click(function(){return upForm.toggle('upload')}),$('#delete-this').click(function(){return upForm.toggle('delete')}),$('#save-draft').click(function(){return drafts.submit()}),$('#draft-saveasnew').click(a),$('#draft-changeid').click(function(){drafts.remove(libchan.current.id),a()}),$('#draft-savemodifiedid').click(function(){return $('#chan-id').val($('#proposed-id').text()),drafts.submit(),!1}),$('#draft-overwrite').click(function(){return drafts.remove($('#id-to-overwrite').text()),drafts.submit(),!1}),drafts.load()};function refreshCaptcha(){$('.captcha').attr('src','/captcha.php?color=255,255,255&v='+Math.random()).removeClass('not-loaded'),$('#captcha').val('')}function toggleLib(a){$('#chan-library').toggleClass('expanded',a),localStorage['chanlib-expanded']=+$('#chan-library').hasClass('expanded')}var gradient={make:function make(a,b,d){return'radial'===a?'radial-gradient(ellipse at center, '+b+' 0%, '+d+' 100%)':'linear-gradient(to '+a+', '+b+' 0%, '+d+' 100%)'},prefixify:function prefixify(a){var b=/(((?:radial|linear)-gradient)\((?:(ellipse) at center|(-?[0-9]+)deg|to (right|bottom)), ?(.+)\));?/i.exec(a);if(null===b)return'background:'+a;b=_.rest(_.without(b,void 0));var h,d=b[0]+'; ',g=b[1];h=isNaN(b[2])?'bottom'==b[2]?'top, ':'right'==b[2]?'left, ':'center, ellipse cover, ':90-parseFloat(b[2])+'deg, ';var j=b[3];return _.each(['-o-','-webkit-','-moz-'],function(l){d+='background:'+l+g+'('+h+j+'); '}),'background:'+d},getValue:function getValue(){var a='#'+$('#bgc-from').val(),b='#'+$('#bgc-to').val();return this.make('bottom',a,b)},update:function update(){var a=this.getValue();injector.inject('chanball-background','.chanball-wrap { '+this.prefixify(a)+' }')}},injector={inject:function inject(a,b){var d='injector:'+a,g=document.getElementById(d);if(g)return void(g.innerHTML=b);var h=document.head||document.getElementsByTagName('head')[0],j=document.createElement('style');j.type='text/css',j.id=d,j.styleSheet?j.styleSheet.cssText=b:j.appendChild(document.createTextNode(b)),h.appendChild(j)},remove:function remove(a){var b='injector:'+a,d=document.getElementById(b);if(d){var g=document.head||document.getElementsByTagName('head')[0];g&&g.removeChild(document.getElementById(b))}}},ball={handleFile:function handleFile(a){a.stopPropagation(),a.preventDefault(),a=a.originalEvent,$('body').removeClass('dropping');var b='drop'==a.type?a.dataTransfer.files:a.target.files,d=b[0];if(d&&'image/png'==d.type){var g=new FileReader;g.onload=function(){return function(h){this.setBall(h.target.result)}.bind(this)}.bind(this)(d),g.readAsDataURL(d)}else d&&this.showErrors('image-not-png')},setBall:function setBall(a){var _this6=this,b;if('string'==typeof a)b=a;else if(!!a.ball)b=a.ball;else if('drafts'!==a.section)b='/chans/balls/'+a.section+'/'+a.id+'.png?uid='+a._id+(a.ballv?'&v='+a.ballv:'');else return void this.clear();var d=$('#chanball').attr('src',b);d.one('load',function(){200<d.width()||200<d.height?_this6.showErrors('image-too-large'):(_this6.file=b,_this6.fType=0===b.indexOf('data:')?'dataURL':'file',_this6.showErrors([]),$('#chanball-sect').addClass('chanball-present'))}),gradient.update()},clear:function clear(){$('#chanball-sect').removeClass('chanball-present'),this.file=null},getData:function getData(a){var _this7=this;return new Promise(function(b,d){var g=[];_this7.file||g.push('no-file');var h=['left','top'].map(function(l){var o=$(jq(_templateObject2,l)),p=+o.val();return isNaN(p)&&(p=0),100<Math.abs(p)&&(p=100*Math.sign(p)),o.val(p),p}),j=['from','to'].map(function(l){var o=$(jq(_templateObject3,l)),p=o.val();return p.match(/[0-9a-f]{6}/i)||(p='ffffff',o[0].jscolor.fromString(p)),p});_this7.offset(),gradient.update(),_this7.showErrors(g),g.length&&!a?d(g):b({ball:'file'===_this7.fType?'default':_this7.file,offset:h,catbg:j})})},toDataURL:function toDataURL(){var _this8=this;'data'!=this.fType&&this.file&&getDataUri(this.file,function(a){_this8.file=a,_this8.fType='data'})},errorDescriptors:{'no-file':'\u0418\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442','image-not-png':'\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u0442\u0438\u043F \u0444\u0430\u0439\u043B\u0430 (\u0434\u043E\u043B\u0436\u0435\u043D \u0431\u044B\u0442\u044C PNG)','image-too-large':'\u0420\u0430\u0437\u043C\u0435\u0440 \u0444\u0430\u0439\u043B\u0430 \u043D\u0435 \u0434\u043E\u043B\u0436\u0435\u043D \u043F\u0440\u0435\u0432\u044B\u0448\u0430\u0442\u044C 200 \u043F\u043A\u0441','upload-error':'\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043D\u0438\u0438 \u0444\u0430\u0439\u043B\u0430'},file:null,fType:null,offset:function offset(){var a=+$('#position-tweak-top').val(),b=+$('#position-tweak-left').val();return $('#chanball').css({transform:'translate('+b+'px, '+a+'px)','-webkit-transform':'translate('+b+'px, '+a+'px)','-ms-transform':'translate('+b+'px, '+a+'px)','-moz-transform':'translate('+b+'px, '+a+'px)','-o-transform':'translate('+b+'px, '+a+'px)'}),[a,b]},showErrors:mkErrorShower('ball')},tree={build:function build(a){var _this9=this,b='';if(a){if('string'==typeof a)try{a=JSON.parse(a)}catch(d){return this.toggleView('JSON',!0),void $('#tree-json').val(a)}a.length&&this.isFlat(a)&&(a=[{name:'',boards:a}]),a.forEach(function(d){b+=_this9.buildCat(d)})}return $('#categories').html(b),document.querySelectorAll('.tree-cat ul').forEach(this.makeBoardsSortable.bind(this)),$('#tree-json').val(JSON.stringify(this.deconstruct(),null,'\t')),this.validateUI()},isFlat:function isFlat(a){return a[0].hasOwnProperty('dir')},boardHeight:24,addBoardButtonHeight:27,buildCat:function buildCat(a){a.boards=a.boards||[];var b=this.buildBoards(a.boards),d=0===a.boards.length,g=(a.boards.length+1)*this.boardHeight+this.addBoardButtonHeight;return'<div class="tree-cat '+(d?'empty':'')+'">\n\t\t<div class="tree-cathead">\n\t\t\t<svg class="icon f-plus" title="\u0420\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C"><use xlink:href="#i-folder-plus-fill"></use></svg>\n\t\t\t<svg class="icon f-minus" title="\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C"><use xlink:href="#i-folder-minus-fill"></use></svg>\n\t\t\t<svg class="icon f-empty"><use xlink:href="#i-folder-empty"></use></svg>\n\t\t\t<input type="text" class="cat-title" value="'+(_.escape(a.name)||'')+'"></input>\n\t\t\t<button class="b-option cat-undelete" title="\u041E\u0442\u043C\u0435\u043D\u0438\u0442\u044C \u0443\u0434\u0430\u043B\u0435\u043D\u0438\u0435">\n\t\t\t\t<svg class="icon"><use xlink:href="#i-undo"></use></svg>\n\t\t\t</button>\n\t\t\t<div class="cat-dragger" title="\u0421\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438">\n\t\t\t\t<svg class="b-option icon"><use xlink:href="#i-drag"></use></svg>\n\t\t\t</div>\n\t\t\t<button class="b-option delb delcat" title="\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u044E">\n\t\t\t\t<svg class="icon"><use xlink:href="#i-x"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="tree-catboards" style="max-height: '+g+'px">'+b+'</div></div>'},buildBoards:function buildBoards(a){var _this10=this,b='<ul>';return a.forEach(function(d){b+=_this10.buildBoard(d)}),b+='</ul><button class="tree-add add-board" title="\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0434\u043E\u0441\u043A\u0443">\n\t\t\t<div class="inner-border">\n\t\t\t\t<svg class="icon"><use xlink:href="#i-slash-plus-slash"></use></svg>\n\t\t\t</div>\n\t\t</button>',b},buildBoard:function buildBoard(a){return escHTML(_templateObject4,a.external?'external':'',a.dir||a.url||'',a.desc||'')},recalcHeight:function recalcHeight(a){a instanceof jQuery||(a=$(a).parent());var b=a.find('.cat-brd').length,d=(b+1)*this.boardHeight+this.addBoardButtonHeight;a.css({'max-height':d+'px'}),a.parent().toggleClass('empty',0==b)},addBoard:function addBoard(a,b){b=b||{},a.parent().find('ul').append(this.buildBoard),this.recalcHeight(a.parent()),a.parent().find('.cat-brd:last input:first').focus()},removeBoard:function removeBoard(a){var b=a.parents('.tree-catboards');a.parents('.cat-brd').remove(),this.recalcHeight(b),this.validateUI()},addCategory:function addCategory(a){a.hasOwnProperty('boards')||(a={name:'',boards:[]});var b=$(this.buildCat(a));this.makeBoardsSortable(b.find('ul')[0]),$('#categories').append(b),b.find('.cat-title').focus()},removeCategory:function removeCategory(a){a.parents('.tree-cat').remove(),this.validateUI()},makeBoardsSortable:function makeBoardsSortable(a){var _this11=this;Sortable.create(a,{handle:'.dragger',animation:150,group:'boards',onAdd:function onAdd(b){[b.from,b.to].forEach(_this11.recalcHeight.bind(_this11)),_this11.validateUI()}})},validateJSON:function validateJSON(){try{var a=JSON.parse($('#tree-json').val());return this.build(a),1}catch(a){return this.showErrors(a),$('#view-toggle').shake(),0}},validateUI:function validateUI(a){var b=[],d=this.deconstruct();$('#tree .invalid').length&&_.keys(this.errorDescriptors).forEach(function(p){$(jq(_templateObject5,p)).length&&b.push(p)});var g=[],h=function h(p){return g.push(p.external?p.url:p.dir)},j=[];d.forEach(function(p){j.push(p.name),p.boards.forEach(h)});var l=findDuplicates(j);l.length&&function(){b.push('mul-cat');var p=$('.cat-title');l.forEach(function(q){return $(p[q]).addClass('invalid')})}();var o=findDuplicates(g);return o.length&&function(){b.push('mul-dir');var p=$('.board-dir');o.forEach(function(q){return $(p[q]).addClass('invalid')})}(),this.showErrors(b),b.length&&!a?!1:d},deconstruct:function deconstruct(){$('#tree .invalid').removeClass('invalid '+_.map(_.keys(this.errorDescriptors),function(g){return'inv_'+g}).join(' '));var a=[],b=$('.tree-cat'),d=!1;return 1==b.length&&(d=!0),$('.tree-cat').each(function(){var g=$(this),h=[],j=g.find('.cat-brd');j.length?j.each(function(){var p=$(this).find('.board-desc'),q=p.val().trim();q||p.addClass('invalid inv_no-desc');var s={desc:q},t=$(this).find('.board-dir'),u=t.val().trim();u||t.addClass('invalid inv_no-dir');var x=!!u.match(/^https?:\/\//);$(this).toggleClass('external',x),s[x?'url':'dir']=u,x&&(s.external=!0),h.push(s)}):g.addClass('invalid inv_empty-dir');var l=g.find('.cat-title'),o=l.val().trim();d||o||l.addClass('invalid inv_no-name'),a.push({name:o,boards:h})}),a},toggleView:function toggleView(a,b){var d=$('#chan-structure').hasClass('sw_UI')?'UI':'JSON';if('undefined'==typeof a&&(a='UI'==d?'JSON':'UI'),d==a)return null;if('JSON'===a)$('#tree-json').val(JSON.stringify(this.deconstruct(),null,'\t'));else{var g=this.validateJSON();if(b)return $('#tree-json').val();if(!g)return!1}return $('#chan-structure').removeClass('sw_UI sw_JSON').addClass('sw_'+a),1},errorDescriptors:{'no-name':'\u041F\u0443\u0441\u0442\u043E\u0435 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0440\u0430\u0437\u0434\u0435\u043B\u0430','no-dir':'\u041F\u0443\u0441\u0442\u043E\u0439 \u043F\u0443\u0442\u044C \u0434\u043E\u0441\u043A\u0438','no-desc':'\u041F\u0443\u0441\u0442\u043E\u0435 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0434\u043E\u0441\u043A\u0438','mul-dir':'\u041F\u043E\u0432\u0442\u043E\u0440\u044F\u044E\u0449\u0438\u0435\u0441\u044F \u0438\u043C\u0435\u043D\u0430 \u0434\u043E\u0441\u043E\u043A','mul-cat':'\u041F\u043E\u0432\u0442\u043E\u0440\u044F\u044E\u0449\u0438\u0435\u0441\u044F \u0438\u043C\u0435\u043D\u0430 \u0440\u0430\u0437\u0434\u0435\u043B\u043E\u0432','empty-dir':'\u041F\u0443\u0441\u0442\u043E\u0439 \u0440\u0430\u0437\u0434\u0435\u043B','bad-json':'JSON \u2014 \u0438\u043D\u0432\u0430\u043B\u0438\u0434'},showErrors:mkErrorShower('struct')};function mkErrorShower(a){return function(b){var _this12=this;b instanceof Array||(b=[b]);var d=a instanceof jQuery?a:$(jq(_templateObject6,a)),g=d.find('.error-msg .tooltip'),h=0<b.length,j=1<b.length,l=(j?'\u041E\u0431\u043D\u0430\u0440\u0443\u0436\u0435\u043D\u044B \u043E\u0448\u0438\u0431\u043A\u0438: <ul>':'')+b.reduce(function(o,p){return o+escHTML(_templateObject7,j?'<li>':'',_this12.errorDescriptors&&_this12.errorDescriptors[p]||p,j?'</li>':'')},'')+(j?'</ul>':'');g.html(l),d.setTipperState(h?'error-tip':'question'),h&&d.shake(),this instanceof HTMLElement&&$(this).toggleClass('invalid',h)}}$.fn.shake=function(){var _this13=this;this.addClass('shake'),setTimeout(function(){return _this13.removeClass('shake')},900)},$.fn.setTipperState=function(a){this.removeClass(_.without(['question','error-tip','spinner','valid'],a).join(' ')).addClass(a)};function findDuplicates(a){var b=[];return a.forEach(function(d,g){1<a.length-_.without(a,d).length&&b.push(g)}),b}var styles={preamble:function preamble(a){var b=[];return['chan-id','bgColor','linkColor'].forEach(function(d){return b[d]='html'==a?'<span class="binded" data-bind="'+d+'"></span>':$(jq(_templateObject,d)).val()}),'less'==a&&(b['chan-id']='css-preview'),'.chan-'+b['chan-id']+' {'+('\n  @bgcolor: #'+b.bgColor+';')+('\n  @linkcolor: #'+b.linkColor+';')},update:function update(a){var _this14=this;a='function'==typeof a?a:null;var b=this.parseInput();if(!b)return void(a&&a(!1));var d=this.preamble('less')+b+'}';less.render(d).then(function(g){injector.inject('chanclass-preview',g.css),a&&a(!0)},function(g){_this14.showErrors(g.message),a&&a(!1)})},getData:function getData(a){var _this15=this;return new Promise(function(b,d){var g={colors:['bg','link'].map(function(h){var j=$(jq(_templateObject8,h)),l=j.val();return l.match(/[0-9a-f]{6}/i)||(l=j.attr('value'),j[0].jscolor.fromString(l)),l})};$('#advance-less').prop('checked')?(g.advanced_less=lessFormatter.minify($('#less-enter').val()),_this15.update(function(h){a||h?b(g):d()})):b(g)})},errorDescriptors:{'bracket-imbalance':'\u0421\u043A\u043E\u0431\u043A\u0438 \u043D\u0435 \u0441\u0431\u0430\u043B\u0430\u043D\u0441\u0438\u0440\u043E\u0432\u0430\u043D\u044B'},parseInput:function parseInput(){var a=[],b=$('#less-enter').val(),d=b.replace(/\/\*.+?\*\/|".+?"|'.+?'/,'').replace(/[^()\[\]{}]/g,''),g=function(h){for(var j={']':'[','}':'{',')':'('},l=[],o=!0,p=0,q=h.length;o&&p<q;p++)j[h[p]]?o=l.pop()===j[h[p]]:l.push(h[p]);return o&&!l.length}(d);return g||a.push('bracket-imbalance'),this.showErrors(a),!a.length&&b},showErrors:mkErrorShower('style'),reset:function reset(){['bg','link'].forEach(function(a){var b=$(jq(_templateObject8,a));b[0].jscolor.fromString(b.data('default'))}),$('#advance-less').prop('checked',0).trigger('change'),this.update(),$('#custom-css').prop('checked',0).trigger('change')}};styles.base='background: @bgcolor;\na, .chan-overlay .icon {\n\tcolor: @linkcolor;\n}\n&:hover {\n\tbackground: darken(@bgcolor, 8%);\n}\n&.onchan {\n\tbox-shadow: inset -2px 0 fadeout(@linkcolor, 25%);\n}\n& when (lightness(@bgcolor) < 70%) {\n\tcolor: #C3C3C3;\n\ta:hover, .ch-name:hover, .icon:hover, .rw-playpause:hover, .volumeter:hover {\n\t\tcolor: white;\n\t}\n\t.board:hover {\n\t\tbackground: rgba(255, 255, 255, .08);\n\t}\n}\n& when (lightness(@bgcolor) > 70%) {\n\tcolor: #404040;\n\ta:hover, .ch-name:hover, .icon:hover, .rw-playpause:hover, .volumeter:hover {\n\t\tcolor: black;\n\t}\n\t.board:hover {\n\t\tbackground: rgba(0, 0, 0, .08);\n\t}\n}\n';var radio={buildStream:function buildStream(a){return escHTML(_templateObject9,a.n?' templated':'',a.name||'',a.n||'',a.path||'',a.mime||'')},addStream:function addStream(a){a=a||{};var b=$(this.buildStream(a));$('#streams').append(b)},build:function build(a){var _this16=this;$('#chan-radiourl').val(a.url),$('#streams').html(a.streams.reduce(function(b,d){return b+_this16.buildStream(d)},''))},removeStream:function removeStream(a){return a.parents('.stream').remove()},reset:function reset(){this.build({url:'',streams:[]}),$('#radio-editor').hide(),$('#radio').prop('checked',!1)},getData:function getData(a){var _this17=this;return new Promise(function(b,d){var g=function g(h,j){j=j?j.map(function(p){return'URL: '+p}):[],$('#chan-radiourl').toggleClass('invalid',!!j.length),$('#streams input').removeClass('invalid '+_.map(_.keys(_this17.errorDescriptors),function(p){return'inv_'+p}).join(' '));var l=[],o=$('.stream');o.length?(o.each(function(){var p=$(this),q={};if(['name','path','mime'].forEach(function(s){var t=p.find('.stream-'+s),u=t.val();u||t.addClass('invalid inv_no-'+s),q[s]=u}),l.push(q),p.hasClass('templated')){var s=p.find('.stream-range'),t=s.val();t?mixedRange(t).length?q.n=t:s.addClass('invalid inv_bad-range'):s.addClass('invalid inv_no-range')}}),$('#streams .invalid').length&&_.keys(_this17.errorDescriptors).forEach(function(p){$(jq(_templateObject10,p)).length&&j.push(p)}),['name','path'].forEach(function(p){var q=findDuplicates(_.pluck(l,p));q.length&&function(){j.push('mul-'+p);var s=$(jq(_templateObject11,p));q.forEach(function(t){return $(s[t]).addClass('invalid')})}()})):j.push('no-streams'),_this17.showErrors(j),!a&&j.length?d(j):b({url:h,streams:l})};$('#chan-radiourl')[0].validate(!0).then(function(h){g(h,null)},function(h){g(null,h)})})},showErrors:mkErrorShower('radio'),errorDescriptors:{'no-streams':'\u0414\u043E\u0431\u0430\u0432\u044C\u0442\u0435 \u0445\u043E\u0442\u044F \u0431\u044B \u043E\u0434\u0438\u043D \u0441\u0442\u0440\u0438\u043C','no-name':'\u041F\u0443\u0441\u0442\u043E\u0435 \u0438\u043C\u044F \u0441\u0442\u0440\u0438\u043C\u0430','no-path':'\u041F\u0443\u0441\u0442\u0430\u044F \u0441\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0440\u0438\u043C','no-mime':'\u041E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 MIME','mul-name':'\u041F\u043E\u0432\u0442\u043E\u0440\u044F\u044E\u0449\u0438\u0435\u0441\u044F \u0438\u043C\u0435\u043D\u0430 \u0441\u0442\u0440\u0438\u043C\u043E\u0432','mul-path':'\u041F\u043E\u0432\u0442\u043E\u0440\u044F\u044E\u0449\u0438\u0435\u0441\u044F \u0441\u0441\u044B\u043B\u043A\u0438 \u043D\u0430 \u0441\u0442\u0440\u0438\u043C\u044B','no-range':'\u041D\u0435 \u0432\u0432\u0435\u0434\u0435\u043D \u0434\u0438\u0430\u043F\u0430\u0437\u043E\u043D \u0440\u0430\u0437\u043C\u043D\u043E\u0436\u0435\u043D\u0438\u044F','bad-range':'\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u0444\u043E\u0440\u043C\u0430\u0442 \u0434\u0438\u0430\u043F\u0430\u0437\u043E\u043D\u0430 \u0440\u0430\u0437\u043C\u043D\u043E\u0436\u0435\u043D\u0438\u044F'}},library={build:function build(a,b){var _this18=this;a.forEach(function(d){return _this18.addChan(d,b||(d.default?'default':'custom'))})},buildChan:function buildChan(a,b){if(b=b||a.section,!b)return console.error('No section specified for buildChan()');var d=a.ball||'/chans/balls/'+b+'/'+('drafts'==b?'no-ball':a.id)+'.png?uid='+a._id+(a.ballv?'&v='+a.ballv:''),g=(a.id+' '+a.name+' '+a.url.replace(/^https?:\/\//,'')+' '+(a.wiki||'').replace(/^https?:\/\//,'')).toLowerCase().trim().replace(/[<>""]/g,''),h='drafts'===b?'\n\t\t<button class="btn export-draft">\n\t\t\t<svg class="icon" title="\u042D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0447\u0435\u0440\u043D\u043E\u0432\u0438\u043A"><use xlink:href="#i-download"></use></svg>\n\t\t</button>':'',j=escHTML(_templateObject12,b,a.name?'':' no-name',a.id,g,d,a.name||'\u0411\u0435\u0437 \u0438\u043C\u0435\u043D\u0438')+h+'\n\t\t</li>',l=$(j);return a.section=b,l[0]._libdata=a,l},addChan:function addChan(a,b,d){if('undefined'==typeof d&&(d=!1),b=b||a.section,!b)return console.error('No section specified for addChan()');var g=this.buildChan(a,b);g.appendTo('#chans'),d&&this.highlight(g);var h=g[0]._libdata;return h},editChan:function editChan(a){var b=$(jq(_templateObject13,a.id)),d=b[0]._libdata;return _.assign(d,a),b.replaceWith(this.buildChan(d,d.section)),this.highlight($(jq(_templateObject13,a.id))),d},deleteChan:function deleteChan(a){$(jq(_templateObject13,a)).remove()},highlight:function highlight(a){var b=a[0]._libdata.section;$(jq(_templateObject14,b)).click(),a.addClass('fresh'),toggleLib(!0)}},libchan={load:function load(a){upForm.toggle(),this.current=a,this.current.default=+('default'==a.section),this.current.included=+a.included,this.setMode('edit',a.section),$('#chan-id').val(a.id),$('#chan-name').val(a.name).trigger('input'),$('#chan-url').val(a.url),$('#chan-wiki').val(a.wiki||''),$('#chan-userboards').val(a.userboards||''),$('#chan-userboards_catname').val(a.userboards_catname||'2.0'),$('#chan-userboards_system').val(a.userboards_system||'instant'),ball.setBall(a);var b=a.offset||[0,0];$('#position-tweak-left').val(b[0]),$('#position-tweak-top').val(b[1]),ball.offset(),$('#bgc-from')[0].jscolor.fromString(a.catbg[0]),$('#bgc-to')[0].jscolor.fromString(a.catbg[1]),gradient.update(),$('#chan-prefix').val(a.prefix||''),$('#chan-postfix').val(a.postfix||''),tree.build(a.boards),$('#custom-css').prop('checked',!!a.colors),a.colors?($('#color-theme').show(),$('#bgColor')[0].jscolor.fromString(a.colors[0]),$('#linkColor')[0].jscolor.fromString(a.colors[1]),a.advanced_less?($('#advance-less').prop('checked',1).trigger('change'),$('#less-enter').val(lessFormatter.prettify(a.advanced_less))):($('#less-enter').val(lessFormatter.prettify(styles.base)),$('#advance-less').prop('checked',0).trigger('change')),styles.update()):styles.reset(),a.radio?($('#radio-editor').show(),radio.build(a.radio),$('#radio').prop('checked',!0)):radio.reset(),$('#default').prop('checked','default'===a.section),$('#included').prop('checked',!!a.included),this.rinse()},_schema:{integrity:{required:['id','name','url','boards','ball','offset','catbg'],optional:['userboards','prefix','postfix','wiki','radio','colors','advanced_less','userboards_catname','userboards_system'],adminOnly:['default','included']},specialComps:{pairs:['catbg','offset','colors'],objects:['boards','radio'],isNewBall:['ball']},conversions:{toFile:['ball']},defaults:{'':['userboards','prefix','postfix','wiki'],'FFFFFF|FFFFFF':['catbg'],'0|0':['offset'],'2C333D|37C999':['colors'],'2.0':['userboards_catname'],instant:['userboards_system']},fns:{objects:_.eq.bind(_),pairs:function pairs(a,b){var d=[a,b].map(function(g){return g instanceof Array?g.join('|').toLowerCase():g});return d[0]===d[1]},isNewBall:function isNewBall(a,b){return a?b===a:'default'===b},toFile:function toFile(a){return 0===a.indexOf('data:')?a.toBlob():a}}},init:function init(){var _this19=this,a={};_.each(this._schema.integrity,function(b,d){b.forEach(function(g){a[g]={},a[g][d]=!0,'optional'===d&&(a[g].default=null)})}),_.each(this._schema.specialComps,function(b,d){b.forEach(function(g){a[g].eqFn=_this19._schema.fns[d]})}),_.each(this._schema.conversions,function(b,d){b.forEach(function(g){a[g].conv=_this19._schema.fns[d]})}),_.each(this._schema.defaults,function(b,d){b.forEach(function(g){a[g].default=d})}),this.schema=a},mode:'new',setMode:function setMode(a,b){this.mode=a,$('body').toggleClass('edit-draft','edit'===a&&'drafts'===b),$('#chan-id, #save-draft').prop('disabled','edit'===a&&'drafts'!==b),$('#clone-this, #delete-this').prop('disabled','new'===a)},rinse:function rinse(){$('.tipper').setTipperState('question'),$('input').removeClass('invalid')},collectData:function collectData(a){var b='draft'===a;return new Promise(function(d,g){var h={},j=[];['url','name','id','wiki','userboards','userboards_catname','prefix','postfix'].forEach(function(l){var o=$(jq(_templateObject15,l))[0].validate(0,b).then(function(p){h[l]=p});j.push(o)}),j.push(ball.getData(b).then(function(l){_.assign(h,l)})),j.push(new Promise(function(l,o){var p=tree.toggleView('UI',b);if(p)l(p);else if(!1===p)o();else{var q=tree.validateUI(b);q?l(q):o()}h.boards=!1!==tree.toggleView('UI')&&tree.validateUI()}).then(function(l){h.boards=l})),h.userboards_system=$('#chan-userboards_system').val(),$('#radio').prop('checked')&&j.push(radio.getData(b).then(function(l){h.radio=l})),$('#custom-css').prop('checked')&&j.push(styles.getData(b).then(function(l){_.assign(h,l)}));IS_ADMIN&&function(){var l={};['default','included'].forEach(function(o){l[o]=+$(jq(_templateObject,o)).prop('checked')}),_.assign(h,l)}();Promise.all(j).then(function(){return d(h)},function(){return g('fix-errors')})})},proceedWithData:function proceedWithData(a,b){var _this20=this,d=b&&this.current&&'drafts'===this.current.section?'new':this.mode;return new Promise(function(g,h){var j=new FormData,l={},o=[];_this20.collectData(a).then(function(p){'edit'===d&&libchan.current.id!==p.id&&o.push('id-changed'),_.each(_this20.schema,function(q,s){var t;if(!q.adminOnly||IS_ADMIN){if(p.hasOwnProperty(s)?t=p[s]:q.required?o.push('fill-required-fields'):t=null,'edit'===d&&'id'!==s){var u=libchan.current.hasOwnProperty(s)?libchan.current[s]:q.default;if(q.eqFn?q.eqFn(u,t):u===t)return}else if(null===t)return;l[s]=t,'upload'===a&&(q.conv&&(t=q.conv(t)),j.apnd(s,t))}}),o.length?h(_.uniq(o)):(DO_DEBUG&&console.log(l),g({obj:l,fd:j}))},function(p){h(p)})})},clone:function clone(){this.setMode('new'),ball.toDataURL(),$('#chan-id').val(''),$('#chan-name')[0].value+=' (\u043A\u043B\u043E\u043D)',$('#chan-name').trigger('input')},clear:function clear(){['url','name','id','wiki','userboards','prefix','postfix'].forEach(function(a){return $(jq(_templateObject15,a)).val('')}),$('#chan-userboards_catname').val('2.0'),ball.clear(),['from','to'].forEach(function(a){return $(jq(_templateObject3,a))[0].jscolor.fromString('ffffff')}),gradient.update(),[radio,styles].forEach(function(a){return a.reset()}),tree.build('[]'),tree.toggleView('UI'),this.rinse(),this.current=null,this.setMode('new'),upForm.toggle()}},drafts={model:[],load:function load(){var a=localStorage.mydrafts;if(a)try{var b=JSON.parse(a);if('object'!=('undefined'==typeof b?'undefined':_typeof(b))||!b.hasOwnProperty('chans'))throw new Error;this.model=b.chans}catch(b){console.error('Drafts in localStorage are corrupted and will be purged'),localStorage.removeItem('mydrafts')}library.build(this.model,'drafts')},remove:function remove(a){this.model.splice(_.findIndex(this.model,{id:a}),1),library.deleteChan(a),libchan.setMode('new'),this.sync()},add:function add(a){var b=library.addChan(a,'drafts',1);this.model.push(a),libchan.current=b,libchan.setMode('edit','drafts')},edit:function edit(a){var b=library.editChan(a);this.model[_.findIndex(this.model,{id:a.id})]=b},sync:function sync(){localStorage.mydrafts=JSON.stringify({chans:this.model,version:new Date().getTime()})},submit:function submit(){var _this21=this,a=$('#chan-id').val();if('edit'===libchan.mode&&libchan.current.id!==a)return $('#id-to-change').text(libchan.current.id),void upForm.toggle('prompt pr-idchanged');if('new'===libchan.mode&&_.find(this.model,{id:a})){$('#id-to-overwrite').text(a);var b=/(.+?)(\d+)$/.exec(a);return $('#proposed-id').text(b?''+b[1]+(+b[2]+1):a+'2'),void upForm.toggle('prompt pr-idexists')}upForm.toggle();libchan.proceedWithData('draft').then(function(b){var d=b.obj;'edit'===libchan.mode?_this21.edit(d):_this21.add(d),_this21.sync()},function(b){upForm.showErrors(b)})}};libchan.init();var lessFormatter={minify:function minify(a){return a.replace(/\n/g,' ').replace(/\s{2,}/g,' ').trim()},prettify:function prettify(a){return css_beautify(this.minify(a).replace(/([;{}])/g,'$1\n').replace(/^\s+/gm,'').trim(),{indent_char:'\t',indent_size:1,newline_between_rules:!1})}},validations={urlencode:function urlencode(a){return encodeURI(a)},checkuniq:function checkuniq(a,b){return new Promise(function(d,g){return'edit'===libchan.mode&&libchan.current[b]===a?void d():void $.get('api.php?checkuniq&prop='+b+'&val='+encodeURIComponent(a)).then(function(h){h.error?g('occupied'):d()}).fail(function(h){console.error('XHR error during post-validation',h),g('XHR error')})})}};NodeList.prototype.forEach=Array.prototype.forEach,NodeList.prototype.map=Array.prototype.map,FormData.prototype.apnd=function(a,b){'object'!=('undefined'==typeof b?'undefined':_typeof(b))||b instanceof Blob?this.append(a,b):this.append(a,JSON.stringify(b))},FormData.prototype.inspect=function(){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=this.entries()[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var a=_step.value;console.log(a[0]+' = '+a[1])}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}},Blob.prototype.readAsDataURL=function(a){var b=new FileReader;b.onload=function(d){return a(d.target.result)},b.readAsDataURL(this)},String.prototype.toBlob=function(){try{for(var a=this.split(','),b=a[0].match(/:(.*?);/)[1],d=atob(a[1]),g=d.length,h=new Uint8Array(g);g--;)h[g]=d.charCodeAt(g);return new Blob([h],{type:b})}catch(a){return console.error(a),!1}};function getDataUri(a,b){var d=new Image;d.onload=function(){var g=document.createElement('canvas');g.width=this.naturalWidth,g.height=this.naturalHeight,g.getContext('2d').drawImage(this,0,0),b(g.toDataURL('image/png'))},d.src=a}function mixedRange(a){for(var b,d=[],g=/(?:([0-9]+)(?:\-([0-9]+))?(?:, ?)?)/g;null!==(b=g.exec(a));)b.index===g.lastIndex&&g.lastIndex++,b[2]?d=d.concat(_.range(b[1],+b[2]+1)):d.push(+b[1]);return d}var upForm={$form:null,init:function init(){var _this22=this;this.$form=$('#upload-form').on('submit',this.submit.bind(this)),_.each(this.actorFieldMap,function(a,b){a.forEach(function(d){return _this22.fieldActorMap[d]=b})})},toggle:function toggle(a){if(!a)this.$form.removeClass('expanded');else{this.$form.removeClass('f-upload f-delete f-prompt pr-idchanged pr-idexists').addClass('f-'+a+' expanded');var b=libchan.current&&'drafts'===libchan.current.section&&'delete'===a;$('#upload-form input').prop('required',!b),!b&&$('.captcha').hasClass('not-loaded')&&refreshCaptcha()}},checkFields:function checkFields(){return $('#pswd').val()&&$('#captcha').val()},submit:function submit(a){var _this23=this;a.preventDefault();var b=this.$form.hasClass('f-delete')?'delete':'upload';if(libchan.current&&'drafts'===libchan.current.section&&'delete'==b)return drafts.remove(libchan.current.id),void this.toggle();if(!this.checkFields())return this.showErrors('fill-required-fields');this.$form.addClass('busy');'upload'==b?libchan.proceedWithData(b,!0).then(function(d){_this23.candidate=d.obj,_this23.send(libchan.mode,d.fd)},function(d){_this23.showErrors(d),_this23.$form.removeClass('busy')}):function(){var d=new FormData;$('#chan-id')[0].validate(1).then(function(g){d.apnd('id',g),_this23.candidate={id:g},_this23.send('delete',d)},function(g){return console.error(g)})}()},send:function send(a,b){libchan.current&&'drafts'===libchan.current.section&&(a='new'),b.apnd('action',a),b.apnd('captcha',$('#captcha').val()),b.apnd('password',$('#pswd').val()),DO_DEBUG&&b.inspect();var d=new XMLHttpRequest;d.open('POST','api.php'),d.send(b);var g=this;d.onload=function(h){if(200==this.status){var j=0;try{j=JSON.parse(this.response)}catch(l){console.error(l),console.warn(this.response),g.unbusy(),g.showErrors('invalid-response')}j&&g.handleResponse(j)}else g.unbusy(),g.showErrors('xhr-error'),console.error(h)}},showErrors:mkErrorShower('submit'),errorDescriptors:{'fill-required-fields':'\u0417\u0430\u043F\u043E\u043B\u043D\u0438\u0442\u0435 \u043D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u044B\u0435 \u043F\u043E\u043B\u044F','xhr-error':'\u041E\u0448\u0438\u0431\u043A\u0430 XHR. \u041F\u043E\u0434\u0440\u043E\u0431\u043D\u043E\u0441\u0442\u0438 \u0432 \u043A\u043E\u043D\u0441\u043E\u043B\u0438.','invalid-response':'\u041E\u0448\u0438\u0431\u043A\u0430 XHR (\u043D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u0444\u043E\u0440\u043C\u0430\u0442 \u043E\u0442\u0432\u0435\u0442\u0430). \u041F\u043E\u0434\u0440\u043E\u0431\u043D\u043E\u0441\u0442\u0438 \u0432 \u043A\u043E\u043D\u0441\u043E\u043B\u0438.','id-changed':'ID \u0431\u044B\u043B \u043D\u0435\u043B\u0435\u0433\u0430\u043B\u044C\u043D\u043E \u0438\u0437\u043C\u0435\u043D\u0435\u043D.','nothing-to-edit':'\u041D\u0435\u0447\u0435\u0433\u043E \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C',missing:'\u041D\u0435 \u0432\u0432\u0435\u0434\u0435\u043D \u043F\u0430\u0440\u043E\u043B\u044C','wrong-captcha':'\u041A\u0430\u043F\u0447\u0430 \u0432\u0432\u0435\u0434\u0435\u043D\u0430 \u043D\u0435\u0432\u0435\u0440\u043D\u043E','wrong-password':'\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u043F\u0430\u0440\u043E\u043B\u044C','fix-errors':'\u0418\u0441\u043F\u0440\u0430\u0432\u044C\u0442\u0435 \u043E\u0448\u0438\u0431\u043A\u0438!','db-error':'\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0437\u0430\u043F\u0438\u0441\u0438 \u0432 \u0411\u0414','not-admin':'\u041D\u0435\u043F\u043E\u0445\u043E\u0436\u0435, \u0447\u0442\u043E \u0432\u044B \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440','wrong-value':'\u041D\u0435\u0432\u0435\u0440\u043D\u043E\u0435 \u0437\u043D\u0430\u0447\u0435\u043D\u0438\u0435','chan-does-not-exist':'\u0417\u0430\u043F\u0438\u0441\u044C \u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0432 \u0411\u0414'},actorFieldMap:{ball:['ball','catbg','offset'],styles:['colors','advanced_less'],tree:['boards'],radio:['radio'],admin:['admin']},fieldActorMap:{},unbusy:function unbusy(){this.$form.removeClass('busy'),refreshCaptcha()},handleResponse:function handleResponse(a){var _this24=this;if(this.unbusy(),a.error)(function(){var b=a.error;b instanceof Array||(b=[b]),b=b.map(function(g){if(!g.field)g={field:_this24,msg:g};else{var h=$(jq(_templateObject15,g.field));g.field=h.length&&h[0].showErrors?h[0]:_this24.fieldActorMap.hasOwnProperty(g.field)?window[_this24.fieldActorMap[g.field]]:_this24}return g});var d=_.uniq(_.pluck(b,'field'));_.includes(d,_this24)||(b.push({field:_this24,msg:'fix-errors'}),d.push(_this24)),d.forEach(function(g){var h=_.pluck(_.filter(b,{field:g}),'msg').map(function(j){return _this24.errorDescriptors[j]||j});g.showErrors(_.uniq(h))})})();else{if(this.showErrors([]),'new-success'===a.action){drafts.remove(upForm.candidate.id),delete this.candidate.ball;var _b=this.candidate.section&&'default'===this.candidate.section?'default':'custom',_d=library.addChan(this.candidate,_b,!0);libchan.load(_d),console.log(upForm.candidate.id,this.candidate,_b)}if('edit-success'===a.action){a.moveto&&(this.candidate.section=a.moveto);var _b2=library.editChan(this.candidate);libchan.load(_b2)}'delete-success'===a.action&&(library.deleteChan(this.candidate.id),libchan.setMode('new','draft')),this.toggle()}}},DO_DEBUG=!1;function makeEscapeTagLiteralFn(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:function(b){return b};return function(b){var g='';for(var h=0;h<b.length;h++)g+=b[h],h<(1>=arguments.length?0:arguments.length-1)&&(g+=a(''+(arguments.length<=h+1?void 0:arguments[h+1])));return g}}var jq=makeEscapeTagLiteralFn(function(a){return a.replace(/([!"#$%&'()*+,\-./:;<=>?@[\\\]^`{|}~ ])/g,'\\$1')}),escHTML=makeEscapeTagLiteralFn(_.escape);function LSfetchJSON(a){var b=null,d=localStorage[a];if('undefined'!=typeof d)try{b=JSON.parse(d)}catch(g){console.error(g),localStorage.removeItem(a)}return b}function downloadJSON(a,b){var d=document.getElementById('dl-victim');d.setAttribute('href','data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(a))),d.setAttribute('download',b+'.json'),d.click()}
//# sourceMappingURL=editor.js.map